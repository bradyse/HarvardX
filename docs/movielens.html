<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sara E. Brady, Ph.D.">
<meta name="dcterms.date" content="2025-12-30">

<title>Capstone MovieLens Project – HarvardX Capstone</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dfb324f25d9b1687192fa8be62ac8f9c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">HarvardX Capstone</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#methods-and-analysis" id="toc-methods-and-analysis" class="nav-link" data-scroll-target="#methods-and-analysis">Methods and Analysis</a>
  <ul class="collapse">
  <li><a href="#creating-main-training-and-final-hold-out-datasets" id="toc-creating-main-training-and-final-hold-out-datasets" class="nav-link" data-scroll-target="#creating-main-training-and-final-hold-out-datasets">Creating Main Training and Final Hold-out Datasets</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration">Data Exploration</a>
  <ul class="collapse">
  <li><a href="#basic-structure" id="toc-basic-structure" class="nav-link" data-scroll-target="#basic-structure">Basic Structure</a></li>
  <li><a href="#distinct-values" id="toc-distinct-values" class="nav-link" data-scroll-target="#distinct-values">Distinct Values</a></li>
  <li><a href="#ratings" id="toc-ratings" class="nav-link" data-scroll-target="#ratings">Ratings</a></li>
  <li><a href="#ratings-per-user" id="toc-ratings-per-user" class="nav-link" data-scroll-target="#ratings-per-user">Ratings per User</a></li>
  <li><a href="#ratings-per-movie" id="toc-ratings-per-movie" class="nav-link" data-scroll-target="#ratings-per-movie">Ratings per Movie</a></li>
  </ul></li>
  <li><a href="#creating-test-and-training-sets-for-model-testing" id="toc-creating-test-and-training-sets-for-model-testing" class="nav-link" data-scroll-target="#creating-test-and-training-sets-for-model-testing">Creating Test and Training Sets for Model Testing</a></li>
  <li><a href="#rmse" id="toc-rmse" class="nav-link" data-scroll-target="#rmse">RMSE</a></li>
  <li><a href="#average-model" id="toc-average-model" class="nav-link" data-scroll-target="#average-model">Average Model</a></li>
  <li><a href="#movie-effect-model" id="toc-movie-effect-model" class="nav-link" data-scroll-target="#movie-effect-model">Movie Effect Model</a></li>
  <li><a href="#movie-user-effects-model" id="toc-movie-user-effects-model" class="nav-link" data-scroll-target="#movie-user-effects-model">Movie &amp; User Effects Model</a></li>
  <li><a href="#regularization-of-movie-user-effect" id="toc-regularization-of-movie-user-effect" class="nav-link" data-scroll-target="#regularization-of-movie-user-effect">Regularization of Movie &amp; User Effect</a></li>
  <li><a href="#dimension-reduction-and-svd" id="toc-dimension-reduction-and-svd" class="nav-link" data-scroll-target="#dimension-reduction-and-svd">Dimension Reduction and SVD</a>
  <ul class="collapse">
  <li><a href="#problem-with-unexplained-variance" id="toc-problem-with-unexplained-variance" class="nav-link" data-scroll-target="#problem-with-unexplained-variance">Problem with Unexplained Variance</a></li>
  <li><a href="#pca-via-svd-as-method-for-dimension-reduction" id="toc-pca-via-svd-as-method-for-dimension-reduction" class="nav-link" data-scroll-target="#pca-via-svd-as-method-for-dimension-reduction">PCA via SVD as Method for Dimension Reduction</a></li>
  <li><a href="#problem-with-sparse-data" id="toc-problem-with-sparse-data" class="nav-link" data-scroll-target="#problem-with-sparse-data">Problem with Sparse Data</a></li>
  </ul></li>
  <li><a href="#movie-effect-with-svd" id="toc-movie-effect-with-svd" class="nav-link" data-scroll-target="#movie-effect-with-svd">Movie Effect with SVD</a></li>
  <li><a href="#movie-and-user-effects-with-svd" id="toc-movie-and-user-effects-with-svd" class="nav-link" data-scroll-target="#movie-and-user-effects-with-svd">Movie and User Effects with SVD</a></li>
  <li><a href="#regularized-movie-user-effects-with-svd" id="toc-regularized-movie-user-effects-with-svd" class="nav-link" data-scroll-target="#regularized-movie-user-effects-with-svd">Regularized Movie &amp; User Effects with SVD</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Capstone MovieLens Project</h1>
<p class="subtitle lead">HarvardX Data Science Professional Certificate</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sara E. Brady, Ph.D. </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>The <strong>MovieLens</strong> dataset <span class="citation" data-cites="movielens">(<a href="#ref-movielens" role="doc-biblioref">GroupLens Research, 2009</a>)</span> contains user movie ratings from MovieLens, a movie recommendation service developed by a research lab at the University of Minnesota <span class="citation" data-cites="grouplens">(<a href="#ref-grouplens" role="doc-biblioref">GroupLens Research, 2025</a>)</span>. For this project, I created a movie recommendation system using the 10-million version of this dataset.</p>
<p>The goal was to use machine learning to <strong>generate predicted movie ratings and root mean squared error (RMSE) score</strong>. Below are the steps that were used to:</p>
<ol type="1">
<li><p>Create the main training and final hold-out test datasets.</p></li>
<li><p>Train a machine learning algorithm using the main training set.</p></li>
<li><p>Select a final model based upon the main training set.</p></li>
<li><p>Predict movie ratings using the final hold-out test set.</p></li>
<li><p>Evaluate the accuracy of the generated predictions using the RMSE metric.</p></li>
</ol>
<p>This project simulates on a smaller scale the 2006 Netflix competition, whereby Netflix released a dataset containing 100 million de-identified movie ratings and offered $1 million to whoever could develop an algorithm that was better than the accuracy of its own recommendation system <span class="citation" data-cites="bennett">(<a href="#ref-bennett" role="doc-biblioref">Bennett &amp; Lanning, 2007</a>)</span>.</p>
</section>
<section id="methods-and-analysis" class="level1">
<h1>Methods and Analysis</h1>
<p>The following R packages were used:</p>
<ul>
<li><p><code>tidyverse</code> - Used for basic data wrangling and exploration</p></li>
<li><p><code>caret</code> - Needed to create data partitions used for creating training and test sets</p></li>
<li><p><code>data.table</code> - Important for preserving computing memory and enhancing processing speed</p></li>
<li><p><code>Matrix</code> - Used for creating sparse matrix objects that assist with processing speed and memory</p></li>
<li><p><code>irlba</code> - Used for <em>singular value decomposition</em> on sparse matrices</p></li>
<li><p><code>doParallel</code> - Assists with core parallel processing for processing speed and memory usage</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(irlba)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="creating-main-training-and-final-hold-out-datasets" class="level2">
<h2 class="anchored" data-anchor-id="creating-main-training-and-final-hold-out-datasets">Creating Main Training and Final Hold-out Datasets</h2>
<p>The following code was developed by the HarvardX Team for the course, PH125.9x: Data Science: Capstone. The purpose of creating the <code>edx</code> dataset is to ensure reproducibility to train, develop, and select the final algorithm used for evaluating the RMSE. We will use this dataset for separating into training and test sets, as well as cross-validation in designing and testing the final algorithm. The <code>final_holdout_test</code> dataset will be used to test the final algorithm.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################################</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create edx and final_holdout_test sets </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">##########################################################</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># MovieLens 10M dataset:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># https://grouplens.org/datasets/movielens/10m/</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># http://files.grouplens.org/datasets/movielens/ml-10m.zip</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">timeout =</span> <span class="dv">120</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>dl <span class="ot">&lt;-</span> <span class="st">"ml-10M100K.zip"</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(dl))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="st">"https://files.grouplens.org/datasets/movielens/ml-10m.zip"</span>, dl)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>ratings_file <span class="ot">&lt;-</span> <span class="st">"ml-10M100K/ratings.dat"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(ratings_file))</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(dl, ratings_file)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>movies_file <span class="ot">&lt;-</span> <span class="st">"ml-10M100K/movies.dat"</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(movies_file))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(dl, movies_file)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>ratings <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">str_split</span>(<span class="fu">read_lines</span>(ratings_file), <span class="fu">fixed</span>(<span class="st">"::"</span>), <span class="at">simplify =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                         <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ratings) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"userId"</span>, <span class="st">"movieId"</span>, <span class="st">"rating"</span>, <span class="st">"timestamp"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>ratings <span class="ot">&lt;-</span> ratings <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId =</span> <span class="fu">as.integer</span>(userId),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId =</span> <span class="fu">as.integer</span>(movieId),</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">rating =</span> <span class="fu">as.numeric</span>(rating),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">timestamp =</span> <span class="fu">as.integer</span>(timestamp))</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>movies <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">str_split</span>(<span class="fu">read_lines</span>(movies_file), <span class="fu">fixed</span>(<span class="st">"::"</span>), <span class="at">simplify =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(movies) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"movieId"</span>, <span class="st">"title"</span>, <span class="st">"genres"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>movies <span class="ot">&lt;-</span> movies <span class="sc">%&gt;%</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">movieId =</span> <span class="fu">as.integer</span>(movieId))</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>movielens <span class="ot">&lt;-</span> <span class="fu">left_join</span>(ratings, movies, <span class="at">by =</span> <span class="st">"movieId"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Final hold-out test set will be 10% of MovieLens data</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>, <span class="at">sample.kind=</span><span class="st">"Rounding"</span>) <span class="co"># if using R 3.6 or later</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(1) # if using R 3.5 or earlier</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>test_index <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="at">y =</span> movielens<span class="sc">$</span>rating, <span class="at">times =</span> <span class="dv">1</span>, <span class="at">p =</span> <span class="fl">0.1</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>edx <span class="ot">&lt;-</span> movielens[<span class="sc">-</span>test_index,]</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> movielens[test_index,]</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure userId and movieId in final hold-out test set are also in edx set</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>final_holdout_test <span class="ot">&lt;-</span> temp <span class="sc">%&gt;%</span> </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(edx, <span class="at">by =</span> <span class="st">"movieId"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(edx, <span class="at">by =</span> <span class="st">"userId"</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Add rows removed from final hold-out test set back into edx set</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>removed <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(temp, final_holdout_test)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>edx <span class="ot">&lt;-</span> <span class="fu">rbind</span>(edx, removed)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(dl, ratings, movies, test_index, temp, movielens, removed)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(edx, <span class="at">file =</span> <span class="st">"../9_Capstone/data/edx.rds"</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_holdout_test, <span class="at">file =</span> <span class="st">"../9_Capstone/data/final_holdout_test.rds"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-exploration" class="level2">
<h2 class="anchored" data-anchor-id="data-exploration">Data Exploration</h2>
<section id="basic-structure" class="level3">
<h3 class="anchored" data-anchor-id="basic-structure">Basic Structure</h3>
<p>From the training dataset we created above, we see that there are more than 9 million rows of data with six variables: <code>userId</code>, <code>movieId</code>, <code>rating</code>, <code>timestamp</code>, <code>title</code>, and <code>genres</code>. This data also appears to be organized into a long format, meaning that rows of data include repeated values of the first column (<code>userId</code>).</p>
<p>Our ultimate goal is to use this dataset to predict users’ movie ratings in the final hold-out test set. We will need to use data on users, movies, and ratings to predict the outcome variable, but other variables such as when the rating was given (<code>timestamp</code>) or <code>genres</code> may also be useful. The variable <code>titles</code> will be useful when exploring the data descriptively, but is likely not going to be useful since there will undoubtedly be duplicate movie titles. To index movies, the <code>movieId</code> variable will be the most useful.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(edx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## 'data.frame':    9000055 obs. of  6 variables:
##  $ userId   : int  1 1 1 1 1 1 1 1 1 1 ...
##  $ movieId  : int  122 185 292 316 329 355 356 362 364 370 ...
##  $ rating   : num  5 5 5 5 5 5 5 5 5 5 ...
##  $ timestamp: int  838985046 838983525 838983421 838983392 838983392 838984474 838983653 838984885 838983707 838984596 ...
##  $ title    : chr  "Boomerang (1992)" "Net, The (1995)" "Outbreak (1995)" "Stargate (1994)" ...
##  $ genres   : chr  "Comedy|Romance" "Action|Crime|Thriller" "Action|Drama|Sci-Fi|Thriller" "Action|Adventure|Sci-Fi" ...</code></pre>
</div>
</section>
<section id="distinct-values" class="level3">
<h3 class="anchored" data-anchor-id="distinct-values">Distinct Values</h3>
<p>As mentioned earlier, a long data format means that ID variables are repeated. Therefore, to determine how many users, movies, and genres are included in this dataset, we use the <code>dplyr</code> package to count distinct values in each variable. From this, we see that over 69,000 users rated more than 10,000 movies from 797 unique genres.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>edx_ns <span class="ot">&lt;-</span> edx <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_users =</span> <span class="fu">n_distinct</span>(userId),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">n_movies =</span> <span class="fu">n_distinct</span>(movieId),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">n_genres =</span> <span class="fu">n_distinct</span>(genres))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>edx_ns</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   n_users n_movies n_genres</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1   69878    10677      797</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ratings" class="level3">
<h3 class="anchored" data-anchor-id="ratings">Ratings</h3>
<p>To explore our outcome variable, we see that ratings range from 0.5 to 5.0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(edx<span class="sc">$</span>rating)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## [1] 0.5 5.0</code></pre>
</div>
<p>We will store the average rating so that we can visualize ratings in a plot. A histogram shows the negative skew of ratings. Although the average rating is about 3.5, the most common rating was 4 with over 2.5 million ratings in total.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(edx<span class="sc">$</span>rating)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>edx <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rating) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(rating, n)) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> mu,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">2.8</span>, <span class="at">y =</span> <span class="dv">3000000</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean = "</span>, <span class="fu">round</span>(mu, <span class="dv">3</span>)),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/edx-ratings.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="ratings-per-user" class="level3">
<h3 class="anchored" data-anchor-id="ratings-per-user">Ratings per User</h3>
<p>To determine the number of ratings per user, we count rows by <code>userId</code>. Descriptive statistics suggest that the number of user ratings varies considerably with the standard deviation being larger than the mean.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ratings_users <span class="ot">&lt;-</span> edx <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(userId) <span class="sc">|&gt;</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">Mean =</span> <span class="fu">mean</span>(n),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">Median =</span> <span class="fu">median</span>(n),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">SD =</span> <span class="fu">sd</span>(n),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">Min =</span> <span class="fu">min</span>(n),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">Max =</span> <span class="fu">max</span>(n),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">IQR.25 =</span> <span class="fu">quantile</span>(n, <span class="fl">0.25</span>),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">IQR.75 =</span> <span class="fu">quantile</span>(n, <span class="fl">0.75</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"statistic"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>ratings_users</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## # A tibble: 8 × 2
##   statistic  value
##   &lt;chr&gt;      &lt;dbl&gt;
## 1 N         69878 
## 2 Mean        129.
## 3 Median       62 
## 4 SD          195.
## 5 Min          10 
## 6 Max        6616 
## 7 IQR.25       32 
## 8 IQR.75      141</code></pre>
</div>
<p>Since the number of ratings per user is so positively skewed, transforming the x axis into log values allows us to see the distribution more clearly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>avg_ratings_per_user <span class="ot">&lt;-</span> ratings_users<span class="sc">$</span>value[<span class="fu">which</span>(ratings_users<span class="sc">$</span>statistic<span class="sc">==</span><span class="st">"Mean"</span>)]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(edx, userId) <span class="sc">|&gt;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(n), </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">bins =</span> <span class="dv">60</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"lightgray"</span>) <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> avg_ratings_per_user,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">350</span>, <span class="at">y =</span> <span class="dv">3500</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean = "</span>, <span class="fu">round</span>(avg_ratings_per_user, <span class="dv">3</span>)),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/edx-ratings-per-user.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="ratings-per-movie" class="level3">
<h3 class="anchored" data-anchor-id="ratings-per-movie">Ratings per Movie</h3>
<p>As expected, the number of ratings per movie was heavily positively skewed with some movies being much more popular than others.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ratings_movies <span class="ot">&lt;-</span> edx <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(movieId)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ratings_movies_summary <span class="ot">&lt;-</span> ratings_movies <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">Mean =</span> <span class="fu">mean</span>(n),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">Median =</span> <span class="fu">median</span>(n),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">SD =</span> <span class="fu">sd</span>(n),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">Min =</span> <span class="fu">min</span>(n),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">Max =</span> <span class="fu">max</span>(n),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">IQR.25 =</span> <span class="fu">quantile</span>(n, <span class="fl">0.25</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">IQR.75 =</span> <span class="fu">quantile</span>(n, <span class="fl">0.75</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"statistic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ratings_movies_summary</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 8 × 2</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   statistic  value</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;      &lt;dbl&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 N         10677 </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 Mean        843.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 Median      122 </span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 SD         2238.</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 Min           1 </span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 Max       31362 </span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 IQR.25       30 </span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 8 IQR.75      565</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Over 100 movies only had a single rating, whereas the most frequently-rated movie, Pulp Fiction, had 31,362 ratings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(ratings_movies, n <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## [1] 126</code></pre>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>most_ratings <span class="ot">&lt;-</span> ratings_movies <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(edx, movieId, title) <span class="sc">|&gt;</span> <span class="fu">distinct</span>(), </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"movieId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">==</span> <span class="fu">max</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>most_ratings</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   movieId     n               title</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     296 31362 Pulp Fiction (1994)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The histogram (log-scale transformed) reveals that the average number of ratings per movie is somewhere between 50 and 500, despite the fact that the mean is more than 800. Based upon this data and the data above, we can infer that there are going to be many instances where users did not rate a given movie. The challenge, therefore, is to estimate what their ratings would be on all 10,000+ movies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>avg_ratings_per_movie <span class="ot">&lt;-</span> ratings_movies_summary <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(statistic <span class="sc">==</span> <span class="st">"Mean"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(value)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(edx, movieId) <span class="sc">|&gt;</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(n), </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">bins =</span> <span class="dv">60</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"lightgray"</span>) <span class="sc">+</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> avg_ratings_per_movie,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">4275</span>, <span class="at">y =</span> <span class="dv">390</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean = "</span>, <span class="fu">round</span>(avg_ratings_per_movie, <span class="dv">3</span>)),</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/edx-ratings-per-movie.png" class="img-fluid" style="width:75.0%"></p>
</section>
</section>
<section id="creating-test-and-training-sets-for-model-testing" class="level2">
<h2 class="anchored" data-anchor-id="creating-test-and-training-sets-for-model-testing">Creating Test and Training Sets for Model Testing</h2>
<p>Even though we created the training (<code>edx</code>) and testing (<code>final_holdout_test</code>) datasets, we will only use the <code>final_holdout_test</code> dataset after choosing the final machine learning algorithm. Therefore, we will use the <code>edx</code> dataset to create training and testing partitions to be used during model training. Using the <code>caret</code> package, we generate the indexes for randomly dividing the data into two parts. Then, we create the training and test sets using the indexes generated. The methodology here uses the same logic that the HarvardX Team used above for creating the <code>edx</code> and <code>final_holdout_test</code> sets.</p>
<p>First, we use the caret’s <code>createDataPartition()</code> function to generate indices that are used to subset 90% of the <code>edx</code> dataset into the main training set. Then, we create a <code>temp</code> dataset that will serve as the basis of the indices generated by the data partition, representing 10% of <code>edx</code> data. To ensure that all users and movies appear in the test set, we use dplyr’s <code>semi_join()</code> function to return all rows from <code>temp</code> with a match in <code>train_set</code>. Next, we use <code>anti_join()</code> to return all rows from <code>temp</code> that don’t appear in <code>test_set</code>. Finally, we use <code>rbind()</code>to combine the removed rows with the matched rows to produce our final <code>test_set</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> edx<span class="sc">$</span>rating</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>test_index <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">createDataPartition</span>(y, <span class="at">times =</span> <span class="dv">1</span>, <span class="at">p =</span> <span class="fl">0.1</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">&lt;-</span> edx[<span class="sc">-</span>test_index,]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> edx[test_index,]</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">&lt;-</span> temp <span class="sc">|&gt;</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(train_set, <span class="at">by =</span> <span class="st">"movieId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(train_set, <span class="at">by =</span> <span class="st">"userId"</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>removed <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(temp, test_set)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">&lt;-</span> <span class="fu">rbind</span>(train_set, removed)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(train_set, <span class="st">"../../9_Capstone/data/train-set.rds"</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(test_set,  <span class="st">"../../9_Capstone/data/test-set.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rmse" class="level2">
<h2 class="anchored" data-anchor-id="rmse">RMSE</h2>
<p>To test model accuracy, we will use a commonly used metric for evaluating the extent to which predicted ratings matched actual ratings. When Netflix opened a competition for the best algorithm to predict user ratings <span class="citation" data-cites="nyt">(<a href="#ref-nyt" role="doc-biblioref">Lohr, 2009</a>)</span>, they used the root mean square error (RMSE) to compare the best algorithm against their current algorithm used at the time <span class="citation" data-cites="kaggle">(<a href="#ref-kaggle" role="doc-biblioref">Netflix &amp; Crawford, 2017</a>)</span>. The winning algorithm achieved an RMSE of of 0.8712 <span class="citation" data-cites="bellkor07">(<a href="#ref-bellkor07" role="doc-biblioref">Bell et al., 2007</a>)</span>.</p>
<p>RMSE is often used as an evaluation metric of regression model accuracy. It answers the question: How accurate are a model’s predicted values? Because of how it is calculated, RMSE directly measures prediction error in the same units as the outcome variable. The $1 million prize-winning algorithm, therefore, estimated actual movie ratings within 0.8712 stars on the 5-star rating scale.</p>
<p>The mathematical formula for calculating RMSE is:</p>
<p><span class="math display">\[
\mathrm{RMSE} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2}
\]</span></p>
<p>here:</p>
<ul>
<li><span class="math inline">\(y_i\)</span> is the actual rating for observation <span class="math inline">\(i\)</span>,</li>
<li><span class="math inline">\(\hat{y}_i\)</span> is the predicted rating for observation <span class="math inline">\(i\)</span>,</li>
<li><span class="math inline">\(n\)</span> is the total number of observations</li>
</ul>
<p>In effect, RMSE calculates the residuals, squares them, finds the mean of the squared residuals, and takes the square root.</p>
<p>Then, a simplified formula of RMSE is:</p>
<p><span class="math display">\[
\mathrm{RMSE} = \sqrt{\text{mean}\Big((y_i - \hat{y}_i)^2\Big)}
\]</span></p>
<p>here:</p>
<ul>
<li><span class="math inline">\(y_i\)</span> is the vector of actual ratings</li>
<li><span class="math inline">\(\hat{y}_i\)</span> is the vector of predicted values</li>
</ul>
<p>We can write a function in R to calculate RMSE. The predicted ratings will be generated from whatever model we choose based upon the training datset, and the actual ratings will come from the testing dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>RMSE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual_ratings, predicted_ratings){</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual_ratings <span class="sc">-</span> predicted_ratings)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="average-model" class="level2">
<h2 class="anchored" data-anchor-id="average-model">Average Model</h2>
<p>To benchmark our models, we estimate the naive RMSE using the average rating in the training dataset to predict the test set’s ratings. This code was adapted from <a href="https://rafalab.dfci.harvard.edu/dsbook/large-datasets.html#recommendation-systems-as-a-machine-learning-challenge"><em>Introduction to Data Science</em></a> <span class="citation" data-cites="irizarry">(<a href="#ref-irizarry" role="doc-biblioref">Irizarry, 2019</a>)</span>.</p>
<p>Our average model would look like this: <span class="math inline">\(Y_{u,i} = \mu + \varepsilon_{u,i}\)</span> with <span class="math inline">\(\varepsilon_{u,i}\)</span> independent errors sampled from the same distribution centered at 0 and <span class="math inline">\(\mu\)</span>, the actual “true” rating for all movies.</p>
<p>Since we don’t know the “true” rating for all movies, we predict all unknown ratings with <span class="math inline">\(\hat{\mu}\)</span> using the average of all ratings from the training set. Given this model, our benchmark RMSE is 1.0606.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mu_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(train_set<span class="sc">$</span>rating)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>naive_rmse <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(test_set<span class="sc">$</span>rating, mu_hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>naive_rmse</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1.060636</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By plotting the residuals, we see a plot that looks identical to the histogram of the ratings. This is because we have effectively centered all ratings around the mean.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>naive_df <span class="ot">&lt;-</span> <span class="fu">select</span>(test_set, rating) <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residuals =</span> rating <span class="sc">-</span> mu_hat)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(naive_df, residuals) <span class="sc">|&gt;</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> residuals)) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"lightgray"</span>) <span class="sc">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/naive-residuals.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="movie-effect-model" class="level2">
<h2 class="anchored" data-anchor-id="movie-effect-model">Movie Effect Model</h2>
<p>Now that we have our naive RMSE to benchmark all other models, we start with modeling movie effects (also called <em>bias</em>) using linear regression. Here we add to our previous model a bias term <span class="math inline">\(b_i\)</span> to represent the average rating for movie <span class="math inline">\(i\)</span>:</p>
<p><span class="math display">\[
Y_{u,i} = \mu + b_i + \varepsilon_{u,i}
\]</span> here:</p>
<ul>
<li><span class="math inline">\(Y_{u,i}\)</span> is the rating given by user <span class="math inline">\(u\)</span> of movie <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(\mu\)</span> is the “true” rating for all movies</li>
<li><span class="math inline">\(b_i\)</span> is the “true” rating for movie <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(\varepsilon_{u,i}\)</span> are independent errors sampled from the same distribution centered at 0</li>
</ul>
<p>Remember that in our RMSE equation we need to calculate <span class="math inline">\(\hat{y}_i\)</span>, the predicted rating for observation <span class="math inline">\(i\)</span>. Our goal, then, is to find the values that minimize the distance between our fitted model and the data (i.e., the least squares estimates). Here our model suggests that we can obtain our least squares estimates by taking the average for all ratings and add the average rating of each movie <span class="math inline">\(i\)</span>. The most common way to do this in R is by using the <code>lm</code> function as shown below. However, <strong>do not run this code</strong>. We have over 10,000 movies and each movie would be a predictor in the model, meaning that R would attempt to calculate over 10,000 coefficient estimates, standard errors, <em>t</em> statistics, and <em>p</em> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(rating <span class="sc">~</span> movieId, <span class="at">data =</span> train_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because the least squares estimate <span class="math inline">\(\hat{b}_i\)</span> is simply the average of each user’s rating of movie <span class="math inline">\(i\)</span> minus the average of all ratings, we can calculate <span class="math inline">\(\hat{b}_i\)</span> as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>movie_avgs <span class="ot">&lt;-</span> train_set <span class="sc">|&gt;</span>  </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_by</span>(movieId) <span class="sc">|&gt;</span>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">summarize</span>(<span class="at">avg_rating =</span> <span class="fu">mean</span>(rating),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">b_i_hat =</span> <span class="fu">mean</span>(rating <span class="sc">-</span> mu_hat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then, calculate the predicted values as our model indicates by adding <span class="math inline">\(\hat{\mu}\)</span> (average of all ratings) to <span class="math inline">\(\hat{b}_i\)</span> (average rating of each movie).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>predicted_ratings <span class="ot">&lt;-</span> mu_hat <span class="sc">+</span> test_set <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(movie_avgs, <span class="at">by=</span><span class="st">"movieId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">pull</span>(b_i_hat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With our predicted ratings from our movie effects model, we see that our RMSE improves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fit1_rmse <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(predicted_ratings, test_set<span class="sc">$</span>rating)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fit1_rmse</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.9441454</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Although our accuracy metric improved, our predicted ratings were only accurate within 0.944 points. To explore why relying on movie effects alone may be insufficient, we can calculate the top 1% of movies and store these movie’s ID numbers. In this case, the top 1% of movies refers to movies that had average ratings in the top 1 percentile of all movies. We, then, create a data frame that includes the counts of the number of user ratings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>top_movies <span class="ot">&lt;-</span> movie_avgs <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(b_i_hat <span class="sc">&gt;</span> <span class="fu">quantile</span>(b_i_hat, .<span class="dv">99</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(movieId)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>top1perc <span class="ot">&lt;-</span> train_set <span class="sc">|&gt;</span> </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(movie_avgs, <span class="at">by =</span> <span class="st">"movieId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(movieId <span class="sc">%in%</span> top_movies) <span class="sc">|&gt;</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(movieId, title) <span class="sc">|&gt;</span> </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n =</span> <span class="fu">n</span>(), avg_rating) <span class="sc">|&gt;</span> </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There were 107 movies that were ranked in the top 1% with average ratings at or above 4.1947.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(top1perc)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 107</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(top1perc<span class="sc">$</span>avg_rating)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4.194669 5.000000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we look at a random sample of this data frame we see that the number of ratings vary considerably by movie.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>top1perc <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 10 × 4</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="do">##    movieId title                                                    n avg_rating</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="do">##      &lt;int&gt; &lt;chr&gt;                                                &lt;int&gt;      &lt;dbl&gt;</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  1    1212 Third Man, The (1949)                                 2668       4.31</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  2     593 Silence of the Lambs, The (1991)                     27258       4.21</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  3     904 Rear Window (1954)                                    7172       4.32</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  4    6123 Sunless (Sans Soleil) (1983)                            52       4.21</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  5    1204 Lawrence of Arabia (1962)                             5472       4.21</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  6    1136 Monty Python and the Holy Grail (1975)               13216       4.21</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  7   58185 Please Vote for Me (2007)                                1       4.5 </span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  8    4973 Amelie (Fabuleux destin d'Amélie Poulain, Le) (2001)  7800       4.24</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  9   63772 Bullfighter and the Lady (1951)                          2       4.25</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 10    5291 Rashomon (Rashômon) (1950)                            1289       4.23</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In fact, we see that among the top rated 1% of movies, almost half of them were only rated once. This would be analogous to a user sorting movies by rating and then seeing that a large proportion of them had only a single rating.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>top1perc <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(n)) <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">500</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"lightgray"</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Frequency of Ratings for Top 1% of Movies"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Number of Ratings per Movie"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/top-rated-movies.png" class="img-fluid" style="width:75.0%"></p>
<p>We can also perform a check on the residuals. If the relationship between the ratings and the movie ratings is linear, we should see that there is no relationship between residuals and predicted values when plotting them. With a continuous outcome variable, we would see the residuals “bounce” around the 0 line. Since our outcome variable is on a 5-point scale, we do not see this pattern. However, given the lack of curvature and that the best-fit line is 0, we see that the variances of the error terms are equal. There do appear to be some outliers, such that we predicted 5s but the actual ratings were much lower.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fit1_resid <span class="ot">&lt;-</span> test_set <span class="sc">|&gt;</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(movie_avgs, <span class="at">by=</span><span class="st">'movieId'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_ratings =</span> mu_hat <span class="sc">+</span> b_i_hat,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">residuals =</span> rating <span class="sc">-</span> predicted_ratings)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>p_fit1_resid <span class="ot">&lt;-</span> fit1_resid <span class="sc">|&gt;</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> predicted_ratings, <span class="at">y =</span> residuals)) <span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Plot for Movie Effects Model"</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>p_fit1_resid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/fit1-residuals.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="movie-user-effects-model" class="level2">
<h2 class="anchored" data-anchor-id="movie-user-effects-model">Movie &amp; User Effects Model</h2>
<p>Since we know that users have a bias in how they rate movies, we will estimate the user bias by adding the term <span class="math inline">\(b_u\)</span> to represent the average rating for user <span class="math inline">\(u\)</span> to our model:</p>
<p><span class="math display">\[
Y_{u,i} = \mu + b_i + b_u + \varepsilon_{u,i}
\]</span> here:</p>
<ul>
<li><span class="math inline">\(Y_{u,i}\)</span> is the rating given by user <span class="math inline">\(u\)</span> of movie <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(\mu\)</span> is the “true” rating for all movies</li>
<li><span class="math inline">\(b_i\)</span> is the “true” rating for movie <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(b_u\)</span> is the “true” rating for user <span class="math inline">\(u\)</span></li>
<li><span class="math inline">\(\varepsilon_{u,i}\)</span> are independent errors sampled from the same distribution centered at 0</li>
</ul>
<p>Similar to before, we can estimate the least squares estimate <span class="math inline">\(\hat{b}_u\)</span> by taking the mean of <span class="math inline">\(y_{u,i} - \hat{\mu} - \hat{b}_i\)</span> where <span class="math inline">\(y_{u,i}\)</span> is the rating of movie <span class="math inline">\(i\)</span> from user <span class="math inline">\(u\)</span>, <span class="math inline">\(\hat{\mu}\)</span> is the average of all ratings, and <span class="math inline">\(\hat{b}_i\)</span> is the least squares estimate of the movie effect we calculated earlier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>user_avgs <span class="ot">&lt;-</span> train_set <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">left_join</span>(movie_avgs, <span class="at">by=</span><span class="st">'movieId'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_by</span>(userId) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">summarize</span>(<span class="at">b_u_hat =</span> <span class="fu">mean</span>(rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i_hat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To ensure our predicted values are restricted to values between 0.5 and 5, we include a <code>clamp</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>clamp <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">min =</span> <span class="fl">0.5</span>, <span class="at">max =</span> <span class="dv">5</span>) <span class="fu">pmax</span>(<span class="fu">pmin</span>(x, max), min)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>predicted_ratings <span class="ot">&lt;-</span> test_set <span class="sc">|&gt;</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">left_join</span>(movie_avgs, <span class="at">by=</span><span class="st">"movieId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">left_join</span>(user_avgs, <span class="at">by=</span><span class="st">"userId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">clamp</span>(mu_hat <span class="sc">+</span> b_i_hat <span class="sc">+</span> b_u_hat)) <span class="sc">%&gt;%</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">pull</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that our RMSE has improved even more. We can now estimate within 0.8659 points users’ ratings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fit2_rmse <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(predicted_ratings, test_set<span class="sc">$</span>rating)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fit2_rmse</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8658849</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Although our residuals look better (no outliers), this model still does not address the fact that less popular movies have least squares estimates as high or higher than popular movies. We need a model that could somehow ignore movie averages with a few user ratings and replace those movie averages with the average of all movies. This is the idea behind regularization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fit2_resid <span class="ot">&lt;-</span> test_set <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(movie_avgs, <span class="at">by=</span><span class="st">"movieId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(user_avgs, <span class="at">by=</span><span class="st">"userId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_ratings =</span> <span class="fu">clamp</span>(mu_hat <span class="sc">+</span> b_i_hat <span class="sc">+</span> b_u_hat),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">residuals =</span> rating <span class="sc">-</span> predicted_ratings)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>fit2_resid <span class="sc">|&gt;</span> </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> predicted_ratings, <span class="at">y =</span> residuals)) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Plot for Movie &amp; User Effects Model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/fit2-residuals.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="regularization-of-movie-user-effect" class="level2">
<h2 class="anchored" data-anchor-id="regularization-of-movie-user-effect">Regularization of Movie &amp; User Effect</h2>
<p>The concept of regularization takes into account each predictor’s effect size when calculating their least squares estimates. In this case, we assume that movies or users with a large number of ratings are more reliable than movies or users with a small number of ratings. When calculating the mean of the least squares estimate, we add a penalty term <span class="math inline">\(\lambda\)</span> to the sample size in the denominator. Therefore, in the case of estimating the movie effect term <span class="math inline">\(b_i\)</span>, we previously calculated <span class="math inline">\(mean(y_{u,i} - \hat{\mu})\)</span> or written out in summation notation:</p>
<p><span class="math display">\[
\frac{1}{n}\sum_{i=1}^{n} (y_{u,i} - \hat{\mu})
\]</span></p>
<p>However with a penalized least squares estimate of <span class="math inline">\(b_i\)</span>, we add <span class="math inline">\(\lambda\)</span> as a penalty term to the denominator:</p>
<p><span class="math display">\[
\frac{1}{n+\lambda}\sum_{i=1}^{n} (y_{u,i} - \hat{\mu})
\]</span></p>
<p>If we use, for example, <span class="math inline">\(\lambda = 5\)</span> This means that for movies like The Shawshank Redemption with over 25,000 ratings in the training set, adding 5 to the <code>n()</code> calculation will be trivial. But for movies with only 1 rating, dividing by <code>n() + 5</code> will mean that the least squares estimate will be essentially 0 after subtracting <span class="math inline">\(\hat{b}_i\)</span> from the average <span class="math inline">\(\hat{\mu}\)</span>.</p>
<p>To ensure that we select the optimal value of <span class="math inline">\(\lambda\)</span>, we will write a function that estimates each of the terms in our model based upon different levels of <code>lambdas</code>. We, then, calculate the RMSE for each of the models that differ only based on the <code>lambdas</code> value. Because we are calculating these effects 41 times (length of <code>lambdas</code>), it’s a good idea to document processing time using the <code>Sys.time()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>lambdas <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="fl">0.25</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>rmses <span class="ot">&lt;-</span> <span class="fu">sapply</span>(lambdas, <span class="cf">function</span>(l){</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>     mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(train_set<span class="sc">$</span>rating)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>     b_i <span class="ot">&lt;-</span> train_set <span class="sc">%&gt;%</span> </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(movieId) <span class="sc">%&gt;%</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarize</span>(<span class="at">b_i =</span> <span class="fu">sum</span>(rating <span class="sc">-</span> mu)<span class="sc">/</span>(<span class="fu">n</span>()<span class="sc">+</span>l))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>     b_u <span class="ot">&lt;-</span> train_set <span class="sc">%&gt;%</span> </span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(b_i, <span class="at">by=</span><span class="st">"movieId"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(userId) <span class="sc">%&gt;%</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarize</span>(<span class="at">b_u =</span> <span class="fu">sum</span>(rating <span class="sc">-</span> b_i <span class="sc">-</span> mu)<span class="sc">/</span>(<span class="fu">n</span>()<span class="sc">+</span>l))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>     predicted_ratings <span class="ot">&lt;-</span> test_set <span class="sc">%&gt;%</span> </span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(b_i, <span class="at">by =</span> <span class="st">"movieId"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(b_u, <span class="at">by =</span> <span class="st">"userId"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">clamp</span>(mu <span class="sc">+</span> b_i <span class="sc">+</span> b_u)) <span class="sc">%&gt;%</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(pred)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(<span class="fu">RMSE</span>(predicted_ratings, test_set<span class="sc">$</span>rating))</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> t1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## Time difference of 1.942676 mins</code></pre>
</div>
<p>To visualize whether we selected an appropriate range for <span class="math inline">\(\lambda\)</span>, we plot the RMSE values against the values in <code>lambdas</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(lambdas, rmses)) <span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(lambdas, rmses))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/lambda-plot-m3.png" class="img-fluid" style="width:75.0%"></p>
<p>Despite the extra computation, we see that the <span class="math inline">\(\lambda\)</span> with the lowest RMSE was not much better than the RMSE from the non-regularized movie &amp; user effects model: <code>fit2_rmse</code> = 0.8659. This suggests that we need a model that can take into account the patterns of users and movies beyond their averages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>lambda_m3 <span class="ot">&lt;-</span> lambdas[<span class="fu">which.min</span>(rmses)]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>fit3_rmse <span class="ot">&lt;-</span> <span class="fu">min</span>(rmses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>lambda_m3</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4.25</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>fit3_rmse</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8654354</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dimension-reduction-and-svd" class="level2">
<h2 class="anchored" data-anchor-id="dimension-reduction-and-svd">Dimension Reduction and SVD</h2>
<section id="problem-with-unexplained-variance" class="level3">
<h3 class="anchored" data-anchor-id="problem-with-unexplained-variance">Problem with Unexplained Variance</h3>
<p>Despite estimating movie-to-movie differences through <span class="math inline">\(b_i\)</span> and user-to-user differences through <span class="math inline">\(b_u\)</span>, we are not estimating variation related to groups of movies and users with similar rating patterns. If we look at the residuals for some popular films, we see that non-zero correlations exist. This is expected for movies of the same franchise (Plot A) or the same genre (Plot B). We also see this for overlapping genres (Plot C), as well as non-overlapping genres (Plot D). Because residuals are supposed to be uncorrelated with each other, this suggests that our current model is not capturing certain commonalities between movies and users. Moreover, the commonalities that exist are not readily apparent from knowing the genre, release date, or title.</p>
<p><img src="images/residuals-popular-movies.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="pca-via-svd-as-method-for-dimension-reduction" class="level3">
<h3 class="anchored" data-anchor-id="pca-via-svd-as-method-for-dimension-reduction">PCA via SVD as Method for Dimension Reduction</h3>
<p>Because we have 10,677 predictors (movies) in our model, a popular method for reducing the number of predictors is through <em>principal component analysis</em> (PCA). PCA seeks to identify groups of predictors, whereby predictors within groups are relatively similar and the groups are relatively independent of one another. In this case, the groups of predictors are called principal components (PCs).</p>
<p>Traditionally, PCs are extracted using eigenvalue decomposition in which the <span class="math inline">\(p \times p\)</span> covariance matrix (i.e., the matrix of correlations between predictors) is computed and, then, transformed into a matrix of <span class="math inline">\(p \times p\)</span> eigenvalues (i.e., the variance explained by each PC) using matrix factorization via matrix algebra. See <a href="https://online.stat.psu.edu/stat505/lesson/4/4.5"><span class="citation" data-cites="penn">Penn State (<span>2025</span>)</span></a> for an explanation of eigenvalue calculations.</p>
<p>Because calculating the covariance matrix is computationally intensive on large datasets, an alternative approach to extracting PCs is <em>singular value decomposition</em> (SVD). With SVD, we can avoid calculating the covariance matrix altogether and instead transform the dataset matrix, <span class="math inline">\(\textbf{X}\)</span>, of size <span class="math inline">\(n \times p\)</span> (number of <span class="math inline">\(n\)</span> users by number of <span class="math inline">\(p\)</span> movies) into three special matrices. Two matrices are <em>orthogonal</em> (rotated): <span class="math inline">\(\textbf{U}\)</span> and <span class="math inline">\(\textbf{V}^\top\)</span>. A third matrix, <span class="math inline">\(\Sigma\)</span> is <em>diagonal</em> matrix.</p>
<p>The mathematical formula for SVD then is:</p>
<p><span class="math display">\[
\textbf{X} = \textbf{U}\Sigma\textbf{V}^\top
\]</span> Where:</p>
<ul>
<li><span class="math inline">\(\textbf{X}\)</span> is the data matrix of size <span class="math inline">\(n \times p\)</span></li>
<li><span class="math inline">\(\textbf{U}\)</span> is the left singular vectors of size <span class="math inline">\(n \times n\)</span></li>
<li><span class="math inline">\(\textbf{V}^\top\)</span> is the right singular vectors of size <span class="math inline">\(p \times p\)</span></li>
<li><span class="math inline">\(\Sigma\)</span> is the singular values matrix of size <span class="math inline">\(n \times p\)</span></li>
</ul>
<p>The two orthogonal matrices, <span class="math inline">\(\textbf{U}\)</span> and <span class="math inline">\(\textbf{V}^\top\)</span>, contain information about the column or row space of <span class="math inline">\(\textbf{X}\)</span>. <span class="math inline">\(\textbf{U}\)</span> contains information about the column space of <span class="math inline">\(\textbf{X}\)</span> and summarizes information of different users based on movies. <span class="math inline">\(\textbf{V}^\top\)</span> contains information about the row space of <span class="math inline">\(\textbf{X}\)</span> and summarizes information of different movies based on users. The columns of <span class="math inline">\(\textbf{U}\)</span> and rows of <span class="math inline">\(\textbf{V}^\top\)</span> are hierarchically arranged, such that the first column of <span class="math inline">\(\textbf{U}\)</span> and the first row of <span class="math inline">\(\textbf{V}^\top\)</span> describe more variance than the second column of <span class="math inline">\(\textbf{U}\)</span> and the second row of <span class="math inline">\(\textbf{V}^\top\)</span> and so on.</p>
<p>The importance of the various columns of <span class="math inline">\(\textbf{U}\)</span> and rows of <span class="math inline">\(\textbf{V}^\top\)</span>, therefore, is encoded in the diagonal matrix, <span class="math inline">\(\Sigma\)</span>, in which the values are arranged in descending order by importance, such that, the first value <span class="math inline">\(\sigma_1\)</span> is used to explain more variance in <span class="math inline">\(\textbf{X}\)</span> than the second value <span class="math inline">\(\sigma_2\)</span>, etc. For these matrices, the first <span class="math inline">\(p\)</span> columns can be thought of as as factors or PCs that describe the interactions between users and movies.</p>
<p>In cases where there are more users (<span class="math inline">\(n\)</span>) than predictors (<span class="math inline">\(p\)</span>), calculating the SVD of <span class="math inline">\(\textbf{X}\)</span> means that only the first <span class="math inline">\(p\)</span> columns of <span class="math inline">\(\textbf{U}\)</span> and the first <span class="math inline">\(p \times p\)</span> block of <span class="math inline">\(\Sigma\)</span> are selected (the <span class="math inline">\(p \times p\)</span> matrix <span class="math inline">\(\textbf{V}^\top\)</span> remains unchanged). Given the hierarchical structure of <span class="math inline">\(\Sigma\)</span>, there will be very small singular values toward the bottom that are not very important. We can, therefore, truncate the calculation to only include the first <span class="math inline">\(k\)</span> singular values of <span class="math inline">\(\Sigma\)</span> . These <span class="math inline">\(k\)</span> values are the factors that describe most of the variation in <span class="math inline">\(\textbf{X}\)</span>. When we truncate to <span class="math inline">\(k\)</span> factors, we approximate the matrix <span class="math inline">\(\textbf{X}\)</span> through the following formula:</p>
<p><span class="math display">\[
\textbf{X}_{n \times p} \approx \textbf{U}_{n \times k} \times \Sigma_{k \times k} \times  \textbf{V}^\top_{k \times n} = \hat{\textbf{X}}_{n \times p}
\]</span></p>
<p>Therefore, using SVD for dimension reduction is more efficient than performing a PCA. To properly calculate the predicted values using SVD, the data must be centered. When the data in matrix <span class="math inline">\(\textbf{X}\)</span> is centered, then <span class="math inline">\(\textbf{X}^\top\textbf{X}/(n - 1)\)</span> is equal to the covariance matrix <span class="citation" data-cites="brunton siregar vkernel">(for further explanation of SVD, see <a href="#ref-brunton" role="doc-biblioref">Brunton &amp; Kutz, 2019</a>; <a href="#ref-siregar" role="doc-biblioref">Siregar, n.d.</a>; <a href="#ref-vkernel" role="doc-biblioref">Visual Kernel, 2022</a>)</span>.</p>
</section>
<section id="problem-with-sparse-data" class="level3">
<h3 class="anchored" data-anchor-id="problem-with-sparse-data">Problem with Sparse Data</h3>
<p>As mentioned above, SVD is calculated directly from the data matrix. This means that we need to transform our current long-format data into a wide-format matrix. This is different from how we were able to calculate movie and user effects earlier by grouping a tidy data frame by <code>movieId</code> or <code>userId</code> and then calculating the least squares estimates. To illustrate, see the sample table below of some movies shown earlier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>long_sample <span class="ot">&lt;-</span> test_set <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(movieId <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2959</span>, <span class="dv">260</span>, <span class="dv">1210</span>, <span class="dv">25</span>, <span class="dv">1704</span>, <span class="dv">2959</span>, <span class="dv">924</span>, <span class="dv">1208</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(userId, movieId, rating) <span class="sc">|&gt;</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">remove_rownames</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>long_sample <span class="sc">|&gt;</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">##       userId movieId rating</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1,]   1690    1210      4</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  [2,]  61409    1704      4</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  [3,]  36823    1210      4</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  [4,]  27385    1210      4</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  [5,]  41012     260      5</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  [6,]  46423    1210      5</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  [7,]  39063    1210      4</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  [8,]   7372    1704      1</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  [9,]  11374     260      4</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [10,]  63145      25      5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To perform SVD on this data, we would need to transform the original data into a user-item matrix. However, even for highly popular films, we see that there are many missing values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>user_item_sample_matrix <span class="ot">&lt;-</span> long_sample <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> userId,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> movieId,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> rating) <span class="sc">|&gt;</span> </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"userId"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>user_item_sample_matrix</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="do">##       1210 1704 260 25</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1690     4   NA  NA NA</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 61409   NA    4  NA NA</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 36823    4   NA  NA NA</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 27385    4   NA  NA NA</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 41012   NA   NA   5 NA</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 46423    5   NA  NA NA</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 39063    4   NA  NA NA</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 7372    NA    1  NA NA</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 11374   NA   NA   4 NA</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 63145   NA   NA  NA  5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Even though SVD requires less processing power than PCA, SVD does not work well on sparse matrices. If we were to calculate the entire matrix of <span class="math inline">\(n\)</span> users by <span class="math inline">\(p\)</span> movies, then we would find that less than 2% of data actually contains an observed rating.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>total_cells <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(edx<span class="sc">$</span>userId) <span class="sc">*</span> <span class="fu">n_distinct</span>(edx<span class="sc">$</span>movieId)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>valid_cells <span class="ot">&lt;-</span> <span class="fu">nrow</span>(edx)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>sparsity <span class="ot">&lt;-</span> valid_cells<span class="sc">/</span>total_cells</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>total_cells</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 746087406</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>valid_cells</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 9000055</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>sparsity <span class="co"># proportion of non-missing values</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.012063</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition to having sparse data, we want to calculate the truncated SVD using <span class="math inline">\(k\)</span> singular values, or factors. R’s <code>svd()</code> function is not optimal, because (a) it cannot include missing values and (b) it would attempt to return the complete set of singular values. Even if we imputed the missing values, we would likely run out of computing power and R would crash. A better option for our data is the <code>irlba()</code> function, which returns the number of singular vectors <span class="math inline">\(k\)</span> specified, even if <span class="math inline">\(k\)</span> is less than the maximum value of <span class="math inline">\(p\)</span> predictors.</p>
<p>Before we start, we need to make sure that <code>userId</code> and <code>movieId</code> are stored in the data as factors. We, then, make sure that both test and training sets include all the unique IDs from both columns. Although we did a similar step earlier, we did not need to factorize the ID columns in this manner until now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>user_levels  <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(train_set<span class="sc">$</span>userId))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>movie_levels <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(train_set<span class="sc">$</span>movieId))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">&lt;-</span> train_set <span class="sc">|&gt;</span> </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId_x =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(userId)),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId_x =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(movieId))) <span class="sc">|&gt;</span> </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId_x =</span> <span class="fu">match</span>(userId, user_levels),</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId_x =</span> <span class="fu">match</span>(movieId, movie_levels))</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">&lt;-</span> test_set <span class="sc">|&gt;</span> </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId_x =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(userId)),</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId_x =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(movieId))) <span class="sc">|&gt;</span> </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId_x =</span> <span class="fu">match</span>(userId, user_levels),</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId_x =</span> <span class="fu">match</span>(movieId, movie_levels))</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(train_set, <span class="st">"../9_Capstone/data/train-set.rds"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(test_set,  <span class="st">"../9_Capstone/data/test-set.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="movie-effect-with-svd" class="level2">
<h2 class="anchored" data-anchor-id="movie-effect-with-svd">Movie Effect with SVD</h2>
<p>To start with our SVD models, we will remove the movie-bias effect from the data prior to calculating the SVD. To save memory space and increase processing power, we will switch from the <code>dplyr</code> and <code>tidyr</code> packages’ syntax to the <code>data.table</code> package syntax. After converting both datasets from <code>data.frame</code> objects to <code>data.table</code> objects, we then center the ratings around the average movie mean in the training set. Next, we use the <code>Matrix</code> package to create a sparse matrix object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(train_set)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(test_set)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>col_means <span class="ot">&lt;-</span> train_set[, .(<span class="at">mean_ratings =</span> <span class="fu">mean</span>(rating)), by <span class="ot">=</span> movieId]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>train_set[col_means, centered <span class="sc">:</span><span class="er">=</span> rating <span class="sc">-</span> mean_ratings, on <span class="ot">=</span> <span class="st">"movieId"</span>]</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>(</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(train_set<span class="sc">$</span>userId)),</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">j =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(train_set<span class="sc">$</span>movieId)),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> train_set<span class="sc">$</span>centered,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">user =</span> <span class="fu">levels</span>(<span class="fu">factor</span>(train_set<span class="sc">$</span>userId)), </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">movie =</span> <span class="fu">levels</span>(<span class="fu">factor</span>(train_set<span class="sc">$</span>movieId)))</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>irlba()</code> function from the <code>irlba</code> package finds a few approximate singular values and corresponding singular vectors of the matrix <code>y</code>. Since we do not want to calculate the entire number of <span class="math inline">\(p\)</span> movies, we set the number of right singular vectors and left singular vectors that we want to estimate. In this case, we select <span class="math inline">\(k = 50\)</span> as our arbitrary starting point.</p>
<p>To calculate the predicted matrix, <code>pred_mat</code>, we use the SVD formula to multiply the matrices together. To extract the predicted centered ratings for the test dataset, <code>pred_centered</code> extracts the corresponding cell from <code>pred_mat</code> using the user’s row position and movie’s column position. To extract the correct column means for the test dataset’s movies, <code>movie_means</code> uses <code>match()</code> to find each test movie’s position in the <code>col_means</code> table, retrieving the corresponding mean rating. The final predicted values, <code>pred</code>, are calculated by adding the centered predicted values to their corresponding movie mean. Finally, to benchmark the time it takes to run the algorithm, we track processing time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">irlba</span>(y, <span class="at">nv =</span> <span class="dv">50</span>, <span class="at">nu =</span> <span class="dv">50</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>pred_mat <span class="ot">&lt;-</span> s<span class="sc">$</span>u <span class="sc">%*%</span> <span class="fu">diag</span>(s<span class="sc">$</span>d) <span class="sc">%*%</span> <span class="fu">t</span>(s<span class="sc">$</span>v)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>pred_centered <span class="ot">&lt;-</span> pred_mat[<span class="fu">cbind</span>(test_set<span class="sc">$</span>userId_x, test_set<span class="sc">$</span>movieId_x)]</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>movie_means <span class="ot">&lt;-</span> col_means<span class="sc">$</span>mean_ratings[<span class="fu">match</span>(test_set<span class="sc">$</span>movieId,col_means<span class="sc">$</span>movieId)]</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> pred_centered <span class="sc">+</span> movie_means</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> t1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## Time difference of 47.02883 secs</code></pre>
</div>
<p>After running our SVD model, we see that the accuracy has taken a step backwards. This SVD movie-effect RMSE is better than its least-squares counterpart (<code>fit1_rmse</code> = 0.9441), but it is not better than the models where we also removed user bias. So far the regularized movie and user effects model had the best RMSE, but the difference between the regularized (0.8654) and non-regularized (0.8659) models are negligible. Next we will attempt to use SVD after removing both movie and user biases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>fit4_rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((pred <span class="sc">-</span> test_set<span class="sc">$</span>rating)<span class="sc">^</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fit4_rmse</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8874975</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="movie-and-user-effects-with-svd" class="level2">
<h2 class="anchored" data-anchor-id="movie-and-user-effects-with-svd">Movie and User Effects with SVD</h2>
<p>In removing both the movie and user bias, our goal is to use SVD to identify the most important factors beyond systematic movie and user effects. The resulting patterns calculated from the SVD (i.e., the predicted residuals) can, then, be used to add to the final predicted values, including the global average, <span class="math inline">\(\hat{\mu}\)</span>, movie effects, <span class="math inline">\(b_i\)</span>, and user effects, <span class="math inline">\(b_u\)</span>. First, we calculate <code>mu_hat</code> from the training set. Next, we calculate the <code>movie_means</code> as we had done before. To calculate user means, we first join <code>movie_means</code> with the training set and, then, remove the global average and movie means from each user’s ratings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>mu_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(train_set<span class="sc">$</span>rating)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>movie_means <span class="ot">&lt;-</span> train_set[, .(<span class="at">b_i =</span> <span class="fu">mean</span>(rating <span class="sc">-</span> mu_hat)), by <span class="ot">=</span> movieId]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>user_means <span class="ot">&lt;-</span> train_set[movie_means, on <span class="ot">=</span> <span class="st">"movieId"</span>][</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  , .(<span class="at">b_u =</span> <span class="fu">mean</span>(rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i)), by <span class="ot">=</span> userId]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To remove the user and movie bias from the ratings, we copy the training dataset to <code>train_resid</code> to indicate that it will contain residuals. We, then, join the <span class="math inline">\(b_i\)</span> and <span class="math inline">\(b_u\)</span> terms based on <code>movieId</code> and <code>userId</code>, respectively. Finally, we calculate the residuals by subtracting the global mean, movie means, and user means from each user’s ratings. Using these columns, we create a sparse Matrix object that includes the residuals ready for SVD calculations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>train_resid <span class="ot">&lt;-</span> train_set</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>train_resid[movie_means, b_i <span class="sc">:</span><span class="er">=</span> i.b_i, on <span class="ot">=</span> <span class="st">"movieId"</span>]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>train_resid[user_means, b_u <span class="sc">:</span><span class="er">=</span> i.b_u, on <span class="ot">=</span> <span class="st">"userId"</span>]</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>train_resid[, residual <span class="sc">:</span><span class="er">=</span> rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i <span class="sc">-</span> b_u]</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> train_resid<span class="sc">$</span>userId_x,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">j =</span> train_resid<span class="sc">$</span>movieId_x,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> train_resid<span class="sc">$</span>residual,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">user =</span> <span class="fu">levels</span>(<span class="fu">factor</span>(train_resid<span class="sc">$</span>userId)),</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">movie =</span> <span class="fu">levels</span>(<span class="fu">factor</span>(train_resid<span class="sc">$</span>movieId))</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To calculate the approximate singular values and corresponding singular vectors, we use the <code>irlba()</code> function, and as before, we select <span class="math inline">\(k = 50\)</span> as the number of right and left singular vectors to estimate. Once the singular values are estimated, we calculate the predicted matrix using the SVD formula. Using the correct row and column position for each user and movie, we store the extracted predicted matrix values into <code>pred_residuals</code>. Similarly, we create vectors for movie and user effects based upon their <code>movieId</code> and <code>userId</code> positioning in the test dataset. Finally, we use the <code>clamp()</code> function created earlier to estimate the predicted values, by adding together the global mean, movie effects, user effects, and predicted residuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">irlba</span>(y, <span class="at">nv =</span> <span class="dv">50</span>, <span class="at">nu =</span> <span class="dv">50</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>pred_mat <span class="ot">&lt;-</span> s<span class="sc">$</span>u <span class="sc">%*%</span> <span class="fu">diag</span>(s<span class="sc">$</span>d) <span class="sc">%*%</span> <span class="fu">t</span>(s<span class="sc">$</span>v)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>pred_residuals <span class="ot">&lt;-</span> pred_mat[<span class="fu">cbind</span>(test_set<span class="sc">$</span>userId_x, test_set<span class="sc">$</span>movieId_x)]</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>test_b_i <span class="ot">&lt;-</span> movie_means<span class="sc">$</span>b_i[<span class="fu">match</span>(test_set<span class="sc">$</span>movieId, movie_means<span class="sc">$</span>movieId)]</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>test_b_u <span class="ot">&lt;-</span> user_means<span class="sc">$</span>b_u[<span class="fu">match</span>(test_set<span class="sc">$</span>userId, user_means<span class="sc">$</span>userId)]</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">clamp</span>(mu_hat <span class="sc">+</span> test_b_i <span class="sc">+</span> test_b_u <span class="sc">+</span> pred_residuals)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> t1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## Time difference of 1.539259 mins</code></pre>
</div>
<p>The RMSE has greatly improved after removing both movie and user effects before calculating the SVD. Next, we will determine whether the accuracy could be improved with regularization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fit5_rmse <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(pred, test_set<span class="sc">$</span>rating)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fit5_rmse</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8388077</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="regularized-movie-user-effects-with-svd" class="level2">
<h2 class="anchored" data-anchor-id="regularized-movie-user-effects-with-svd">Regularized Movie &amp; User Effects with SVD</h2>
<p>In the previous model, we removed both the movie and user effects from the data matrix before calculating the singular values. However, could we optimize the number of <span class="math inline">\(k\)</span> singular vectors to estimate? We could also add a penalty term <span class="math inline">\(\lambda\)</span> to the sample size when calculating the movie and user effects. In this model, we attempt to find an optimal <span class="math inline">\(k\)</span> and <span class="math inline">\(\lambda\)</span> value that will yield the lowest RMSE. To do this, we create a function that calculates movie and user effects at different levels of <span class="math inline">\(\lambda\)</span> and then use those calculations to estimate <span class="math inline">\(k\)</span> singular values and corresponding singular vectors.</p>
<p>To start, we select values of <code>lambda</code> from 0 to 5 in increments of 0.5 and values of <code>k</code> at either 50 or 100. Below we use the <code>expand.grid()</code> function to create a data frame from all combinations of <code>lambdas</code> and <code>k_values</code>. The final function will perform an SVD for each combination of <code>lambda</code> and <code>k</code> for a total of 22 different models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>lambdas <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="fl">0.50</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>k_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lambda =</span> lambdas, <span class="at">k =</span> k_values)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>grid</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="do">##    lambda   k</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1     0.0  50</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2     0.5  50</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 3     1.0  50</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 4     1.5  50</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 5     2.0  50</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 6     2.5  50</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 7     3.0  50</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 8     3.5  50</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 9     4.0  50</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 10    4.5  50</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 11    5.0  50</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 12    0.0 100</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 13    0.5 100</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 14    1.0 100</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 15    1.5 100</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 16    2.0 100</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 17    2.5 100</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 18    3.0 100</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 19    3.5 100</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 20    4.0 100</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 21    4.5 100</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 22    5.0 100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performing 22 SVD calculations on this large of a dataset will require a lot of memory and computing power. Therefore, we will use the <code>doParallel</code> package to help. We will first create two copies of R running in parallel, called “clusters.” To ensure the two copies of R can communicate to each other we use the <code>registerDoParallel()</code> function. To ensure the essential objects from the R environment are copied to both copies of R, we use the <code>clusterExport()</code> function to copy the training and test datasets, as well as the average rating of training set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>mu_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(train_set<span class="sc">$</span>rating)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(nc)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(cl, {</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(data.table)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Matrix)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(irlba)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterExport</span>(cl, <span class="fu">c</span>(<span class="st">"train_set"</span>, <span class="st">"test_set"</span>, <span class="st">"mu_hat"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to calculate the RMSE values of the 22 different models, we write a function, <code>rmses()</code> that takes in <code>lambda</code> and <code>k</code> values as arguments and returns the RMSE for each model. The function does the following:</p>
<ul>
<li><code>movie_means_reg</code>: Calculate the <span class="math inline">\(b_i\)</span> movie effects with an added penalty term, <code>lambda</code>, to the sample size in the denominator when calculating the mean.</li>
<li><code>user_means_reg</code>: Calculate the <span class="math inline">\(b_u\)</span> user effects using the added penalty term as above.</li>
<li><code>train_resid</code>: Copy the training set as before to indicate that this will be the dataset that contains residuals.
<ul>
<li>Join the regularized movie and user means to the <code>train_resid</code> dataset so that we can, then, calculate the residual for each observation.</li>
<li>Create the residual column in <code>train_resid</code> by subtracting the global mean, movie bias, and user bias from each observed rating.</li>
</ul></li>
<li><code>y</code>: Using the <code>sparseMatrix()</code> function, create a sparse matrix necessary for the <code>irbla()</code> function.</li>
<li><code>s</code>: Calculate the approximate singular values and singular vectors using the <code>irbla()</code> function. We use the function’s argument variable <code>k</code> for truncating the SVD.</li>
<li><code>pred_residuals</code>: Calculate the predicted residual matrix using the SVD equation.</li>
<li><code>test_residuals</code>: Using the users’ and movies’ row/column positioning in the test dataset, extract the predicted residuals.</li>
<li><code>test_b_i</code>: Create a vector for the movie effects based upon each movie ID’s position in the test dataset</li>
<li><code>test_b_u</code>: Create a vector for the user effects based on user ID’s test set position.</li>
<li><code>pred</code>: Use the <code>clamp()</code> function to save the predicted ratings according to the final model’s formula, by adding together the global average, movie effect, user effect, and predicted residuals.</li>
<li>Finally, return the RMSE by taking the square root of the mean of the squared residuals between the predicted and actual movie ratings.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>rmses <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, k){</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  movie_means_reg <span class="ot">&lt;-</span> train_set[, .(<span class="at">b_i =</span> <span class="fu">sum</span>(rating <span class="sc">-</span> mu_hat)<span class="sc">/</span>(.N <span class="sc">+</span> lambda)), by <span class="ot">=</span> movieId_x]</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  user_means_reg <span class="ot">&lt;-</span> train_set[movie_means_reg, on <span class="ot">=</span> <span class="st">"movieId_x"</span>][</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    , .(<span class="at">b_u =</span> <span class="fu">sum</span>(rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i)<span class="sc">/</span>(.N <span class="sc">+</span> lambda)), by <span class="ot">=</span> userId_x]</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  train_resid <span class="ot">&lt;-</span> train_set</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  train_resid[movie_means_reg, b_i <span class="sc">:</span><span class="er">=</span> i.b_i, on <span class="ot">=</span> <span class="st">"movieId_x"</span>]</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  train_resid[user_means_reg, b_u <span class="sc">:</span><span class="er">=</span> i.b_u, on <span class="ot">=</span> <span class="st">"userId_x"</span>]</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  train_resid[, residual<span class="sc">:</span><span class="er">=</span> rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i <span class="sc">-</span> b_u]</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>(</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> train_resid<span class="sc">$</span>userId_x,</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">j =</span> train_resid<span class="sc">$</span>movieId_x,</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> train_resid<span class="sc">$</span>residual</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">irlba</span>(y, <span class="at">nv =</span> k, <span class="at">nu =</span> k)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>  pred_residuals <span class="ot">&lt;-</span> s<span class="sc">$</span>u <span class="sc">%*%</span> <span class="fu">diag</span>(s<span class="sc">$</span>d) <span class="sc">%*%</span> <span class="fu">t</span>(s<span class="sc">$</span>v)</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  test_residuals <span class="ot">&lt;-</span> pred_residuals[<span class="fu">cbind</span>(test_set<span class="sc">$</span>userId_x, test_set<span class="sc">$</span>movieId_x)]</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  test_b_i <span class="ot">&lt;-</span> movie_means_reg[.(test_set<span class="sc">$</span>movieId_x), b_i, on <span class="ot">=</span> <span class="st">"movieId_x"</span>]</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  test_b_u <span class="ot">&lt;-</span> user_means_reg[.(test_set<span class="sc">$</span>userId_x), b_u, on <span class="ot">=</span> <span class="st">"userId_x"</span>]</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">clamp</span>(mu_hat <span class="sc">+</span> test_b_i <span class="sc">+</span> test_b_u <span class="sc">+</span> test_residuals)</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RMSE</span>(pred, test_set<span class="sc">$</span>rating)</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have set up our parallel processing and written our function, we use the <code>foreach</code> package (attached from the <code>doParallel</code> package) to evaluate in parallel the <code>rmses()</code> function we created above for each row of our <code>grid</code> data frame. Within our <code>rmses()</code> function, we pass through the <span class="math inline">\(i\)</span>th row of the <code>lambda</code> and <code>k</code> columns. We use the <code>.combine = c</code> argument to create a vector of all the RMSE values calculated from each of the 22 models. As usual, we document the processing time using <code>Sys.time()</code>. Note that this code chunk will take between 30-40 minutes of processing time. If possible, close all programs running in the background before running.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid), <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> {</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmses</span>(grid<span class="sc">$</span>lambda[i], grid<span class="sc">$</span>k[i])</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> t1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>## Time difference of 34.44416 mins</code></pre>
</div>
<p>We store the results of all 22 RMSE calculations into a new column in the <code>grid</code> data frame. When we are finished with the entire process we close the created cluster using the <code>stopCluster()</code> and <code>stopImplicitCluster()</code> functions. Lastly, we plot the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>rmse <span class="ot">&lt;-</span> results </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">stopImplicitCluster</span>()</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>lambda_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">k =</span> <span class="fu">factor</span>(k))) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(lambda, rmse, <span class="at">color =</span> k))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>lambda_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="images/lambda-plot-m6.png" class="img-fluid" style="width:75.0%"></p>
<p>As shown in the plot, the lowest RMSE value uses parameters of <span class="math inline">\(\lambda = 5\)</span> and <span class="math inline">\(k = 50\)</span>. Despite the computationally intensive process, this final model is not much better than the non-regularized SVD movie and user effect model we calculated earlier. However, we will select this model with the given regularization parameters to predict movie ratings of the final hold-out test set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>lambda_m6 <span class="ot">&lt;-</span> grid[<span class="fu">which.min</span>(grid<span class="sc">$</span>rmse),<span class="st">"lambda"</span>]</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>k_m6 <span class="ot">&lt;-</span> grid[<span class="fu">which.min</span>(grid<span class="sc">$</span>rmse),<span class="st">"k"</span>]</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>fit6_rmse <span class="ot">&lt;-</span> <span class="fu">min</span>(grid<span class="sc">$</span>rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>lambda_m6</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 5</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>k_m6</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 50</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>fit6_rmse</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8382405</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>To test our final model on the final hold-out test set, we need to calculate the residuals following the removal of the movie and user effects that were estimating using the penalty <span class="math inline">\(\lambda\)</span> term (in this case, <span class="math inline">\(\lambda = 5\)</span>). Although these were created in the earlier function, we did not save the residual matrix when running that function. So we need to calculate these steps one final time here.</p>
<p>After the movie and user effects have been removed, we use the <code>irlba()</code> function to perform SVD for <span class="math inline">\(k\)</span> singular vectors that were identified in the previous model (in this case, <span class="math inline">\(k = 50\)</span>). Then, we use the calculated singular vectors to estimate the predicted residuals according to the SVD formula.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>b_i <span class="ot">&lt;-</span> train_set[, .(<span class="at">b_i =</span> <span class="fu">sum</span>(rating <span class="sc">-</span> mu_hat)<span class="sc">/</span>(.N <span class="sc">+</span> lambda_m6)), by <span class="ot">=</span> movieId_x]</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>b_u <span class="ot">&lt;-</span> train_set[b_i, on <span class="ot">=</span> <span class="st">"movieId_x"</span>][</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  , .(<span class="at">b_u =</span> <span class="fu">sum</span>(rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i)<span class="sc">/</span>(.N <span class="sc">+</span> lambda_m6)), by <span class="ot">=</span> userId_x]</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>train_resid <span class="ot">&lt;-</span> train_set</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>train_resid[movie_means_reg, b_i <span class="sc">:</span><span class="er">=</span> i.b_i, on <span class="ot">=</span> <span class="st">"movieId_x"</span>]</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>train_resid[user_mean_reg, b_u <span class="sc">:</span><span class="er">=</span> i.b_u, on <span class="ot">=</span> <span class="st">"userId_x"</span>]</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>train_resid[, residual<span class="sc">:</span><span class="er">=</span> rating <span class="sc">-</span> mu_hat <span class="sc">-</span> b_i <span class="sc">-</span> b_u]</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>(</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">i =</span> train_resid<span class="sc">$</span>userId_x,</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">j =</span> train_resid<span class="sc">$</span>movieId_x,</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> train_resid<span class="sc">$</span>residual</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">irlba</span>(y, <span class="at">nv =</span> k_m6, <span class="at">nu =</span> k_m6)</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>pred_residuals <span class="ot">&lt;-</span> s<span class="sc">$</span>u <span class="sc">%*%</span> <span class="fu">diag</span>(s<span class="sc">$</span>d) <span class="sc">%*%</span> <span class="fu">t</span>(s<span class="sc">$</span>v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So far we have only been using the <code>test_set</code> partition created at the beginning to test all of our models. As a final step in calculating the accuracy, we use the <code>final_holdout_test</code> dataset that has not been used for any of our model training or testing thus far. Since we have not touched this dataset since it was first created, we need to load and process the <code>final_holdout_test</code> dataset in the same way that was done on the training dataset previously. Specifically, we need to factorize the movie and user ID variables in the <code>final_holdout_test</code> set according to the movie and user ID variables in the <code>train_set</code>. This way, we do not run into indexing problems with missing user or movie IDs in the factor levels. In the last step of preprocessing, we set the final test set data frame as a <code>data.table</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">"../../9_Capstone/data/final_holdout_test.rds"</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>user_levels  <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(train_set<span class="sc">$</span>userId))</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>movie_levels <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(train_set<span class="sc">$</span>movieId))</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>final_test <span class="ot">&lt;-</span> final_holdout_test <span class="sc">|&gt;</span> </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId_x =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(userId)),</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId_x =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(movieId))) <span class="sc">|&gt;</span> </span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">userId_x =</span> <span class="fu">match</span>(userId, user_levels),</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">movieId_x =</span> <span class="fu">match</span>(movieId, movie_levels))</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(final_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, we extract the predicted residuals using the users’ and movies’ row and column positions in the final test dataset. Then, we create the vectors of the movie and user effects based on the final test set ID positions. We use the <code>clamp()</code> function to save the predicted ratings according to the final formula and we calculate the final RMSE between the predicted and actual final test set ratings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>test_residuals <span class="ot">&lt;-</span> pred_residuals[<span class="fu">cbind</span>(final_test<span class="sc">$</span>userId_x, final_test<span class="sc">$</span>movieId_x)]</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>test_b_i <span class="ot">&lt;-</span> b_i[.(final_test<span class="sc">$</span>movieId_x), b_i, on <span class="ot">=</span> <span class="st">"movieId_x"</span>]</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>test_b_u <span class="ot">&lt;-</span> b_u[.(final_test<span class="sc">$</span>userId_x), b_u, on <span class="ot">=</span> <span class="st">"userId_x"</span>]</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">clamp</span>(mu_hat <span class="sc">+</span> test_b_i <span class="sc">+</span> test_b_u <span class="sc">+</span> test_residuals)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>final_rmse <span class="ot">&lt;-</span> <span class="fu">RMSE</span>(pred, final_test<span class="sc">$</span>rating)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our final RMSE is 0.8377, which means that our predicted ratings were accurate within 0.8377 points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>final_rmse</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.8376883</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is a table comparing all of the models that we have tested in the order they were tested, including which training and data sets were used during algorithm training and testing.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 23%">
<col style="width: 23%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Training data</th>
<th>Test data</th>
<th>RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Average (Naive)</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>1.0606</td>
</tr>
<tr class="even">
<td>Movie effect</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>0.9441</td>
</tr>
<tr class="odd">
<td>Movie + user effects</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>0.8659</td>
</tr>
<tr class="even">
<td>Regularized movie + user effect</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>0.8654</td>
</tr>
<tr class="odd">
<td>SVD movie effect</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>0.8875</td>
</tr>
<tr class="even">
<td>SVD movie + user effects</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>0.8388</td>
</tr>
<tr class="odd">
<td>Regularized SVD movie + user effects</td>
<td><code>train_set</code></td>
<td><code>test_set</code></td>
<td>0.8382</td>
</tr>
<tr class="even">
<td><strong>Final model</strong></td>
<td><code>train_set</code></td>
<td><code>final_holdout_test</code></td>
<td><strong>0.8377</strong></td>
</tr>
</tbody>
</table>
<p>To better compare the accuracy of each model, below is a plot of each model sorted by RMSE in descending order with a reference line showing where the winning Netflix prize algorithm was by comparison <span class="citation" data-cites="bellkor07">(<a href="#ref-bellkor07" role="doc-biblioref">Bell et al., 2007</a>)</span>.</p>
<p><img src="images/final-rmses.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Our goal in this project was to use machine learning to generate predicted movie ratings and to test the accuracy of the selected model using the RMSE metric. In an initial step, we created the main training and final hold-out test datasets, such that the final hold-out test dataset was reserved for the final stage of algorithm testing. After partitioning the main training datset into a training and test dataset, we trained and tested six different models that varied in terms of estimating movie and user effects, as well as optimizing parameters through regularization. After evaluating which model produced the lowest RMSE, the selected model employed a truncated singular value decomposition following the removal of movie and user biases that were calculated from penalized least squares estimates. Once our final model was selected, we used the final hold-out test dataset for testing.</p>
<p>Overall, the regularized SVD movie and user effects model led to the lowest RMSE out of any of the six models. However, the incremental decrease in RMSE gained in the final model was minimal compared to the SVD movie and user effects that did not employ a regularization technique. The only difference between these two models was the fact that the regularized model used a penalty, <span class="math inline">\(\lambda\)</span>, term. This suggests, that the least squares estimate is sufficient for estimating systematic movie and user biases. Because the purpose of adding a penalty term is to shrink mean-centered estimates toward 0 on rare items, any estimates on rare movies in the current data were fairly accurate and no overfitting was occurring during model training.</p>
<p>The final algorithm selected in this dataset resulted in an RMSE lower than the winning Netflix prize, which had an RMSE = 0.8712 <span class="citation" data-cites="bellkor07">(<a href="#ref-bellkor07" role="doc-biblioref">Bell et al., 2007</a>)</span>. One year later <span class="citation" data-cites="bellkor08">Bell et al. (<a href="#ref-bellkor08" role="doc-biblioref">2008</a>)</span> released a paper demonstrating a new and improved methodology with an RMSE of 0.8643. The algorithm used by <span class="citation" data-cites="bellkor08">Bell et al. (<a href="#ref-bellkor08" role="doc-biblioref">2008</a>)</span> was trained using a stochastic gradient descent approach with SVD. In addition, <span class="citation" data-cites="bellkor08">Bell et al. (<a href="#ref-bellkor08" role="doc-biblioref">2008</a>)</span> added temporal effects to their model, which predicted a rating at time <span class="math inline">\(t\)</span>. They also note that complex models are only one method of improving accuracy. As demonstrated in their 2008, using a blend of simpler models with fewer predictors was a more efficient approach to improving model accuracy.</p>
<p>Matrix factorization techniques shown in this report are part of methods used in traditional recommendation systems. Newer recommendation systems use artificial intelligence (AI) techniques such as deep neural networks based on large language models. According to <span class="citation" data-cites="zhang">Zhang et al. (<a href="#ref-zhang" role="doc-biblioref">2025</a>)</span>, however, AI-enabled models can vary in terms of accuracy between male and female users. Data scientists interested in developing algorithms for recommendation systems should ensure that training data includes adequate representation of intended users, as well as deciding whether gains in model accuracy are worth the added layers of model complexity.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-bellkor07" class="csl-entry" role="listitem">
Bell, R. M., Koren, Y., &amp; Volinsky, C. (2007). <em>The BellKor solution to the <span>N</span>etflix prize</em>. <a href="https://scispace.com/pdf/the-bellkor-solution-to-the-netflix-prize-3dq3fir055.pdf">https://scispace.com/pdf/the-bellkor-solution-to-the-netflix-prize-3dq3fir055.pdf</a>
</div>
<div id="ref-bellkor08" class="csl-entry" role="listitem">
Bell, R. M., Koren, Y., &amp; Volinsky, C. (2008). <em>The BellKor 2008 solution to the <span>N</span>etflix prize</em>. <a href="https://cseweb.ucsd.edu/classes/fa17/cse291-b/reading/ProgressPrize2008_BellKor.pdf">https://cseweb.ucsd.edu/classes/fa17/cse291-b/reading/ProgressPrize2008_BellKor.pdf</a>
</div>
<div id="ref-bennett" class="csl-entry" role="listitem">
Bennett, J., &amp; Lanning, S. (2007). <em>The <span>N</span>etflix prize</em>. <a href="https://www.cs.uic.edu/~liub/KDD-cup-2007/proceedings/The-Netflix-Prize-Bennett.pdf">https://www.cs.uic.edu/~liub/KDD-cup-2007/proceedings/The-Netflix-Prize-Bennett.pdf</a>
</div>
<div id="ref-brunton" class="csl-entry" role="listitem">
Brunton, S. L., &amp; Kutz, J. N. (2019). <em>Data-driven science and engineering: Machine learning, dynamical systems, and control</em> (First edition). Cambridge University Press. <a href="https://databookuw.com/">https://databookuw.com/</a>
</div>
<div id="ref-movielens" class="csl-entry" role="listitem">
GroupLens Research. (2009). <em>MovieLens 10M dataset</em>. University of Minnesota. <a href="https://grouplens.org/datasets/movielens/10m/">https://grouplens.org/datasets/movielens/10m/</a>
</div>
<div id="ref-grouplens" class="csl-entry" role="listitem">
GroupLens Research. (2025). <em>MovieLens</em>. University of Minnesota. <a href="https://movielens.org/">https://movielens.org/</a>
</div>
<div id="ref-irizarry" class="csl-entry" role="listitem">
Irizarry, R. A. (2019). <em>Introduction to data science: Data analysis and prediction algorithms with <span>R</span></em> (First edition). CRC Press. <a href="https://rafalab.dfci.harvard.edu/dsbook/index.html">https://rafalab.dfci.harvard.edu/dsbook/index.html</a>
</div>
<div id="ref-nyt" class="csl-entry" role="listitem">
Lohr, S. (2009). <em>New York Times</em>. <a href="https://www.nytimes.com/2009/09/22/technology/internet/22netflix.html">https://www.nytimes.com/2009/09/22/technology/internet/22netflix.html</a>
</div>
<div id="ref-kaggle" class="csl-entry" role="listitem">
Netflix, &amp; Crawford, C. (2017). <em>Netflix prize data</em>. Kaggle; <a href="https://www.kaggle.com/datasets/netflix-inc/netflix-prize-data/data" class="uri">https://www.kaggle.com/datasets/netflix-inc/netflix-prize-data/data</a>.
</div>
<div id="ref-penn" class="csl-entry" role="listitem">
Penn State. (2025). <em>Eigenvalues and eigenvectors</em>. Penn State Eberly College of Science; <a href="https://online.stat.psu.edu/stat505/lesson/4/4.5" class="uri">https://online.stat.psu.edu/stat505/lesson/4/4.5</a>.
</div>
<div id="ref-siregar" class="csl-entry" role="listitem">
Siregar, B. (n.d.). <em>Linear algebra</em> (First edition). Kampus Merdeka Indonesia Jaya. <a href="https://bookdown.org/dsciencelabs/lina/">https://bookdown.org/dsciencelabs/lina/</a>
</div>
<div id="ref-vkernel" class="csl-entry" role="listitem">
Visual Kernel. (2022). <em>Singular value decomposition explained | SEE matrix , chapter 3</em>. YouTube; <a href="https://www.youtube.com/watch?v=vSczTbgc8Rc" class="uri">https://www.youtube.com/watch?v=vSczTbgc8Rc</a>.
</div>
<div id="ref-zhang" class="csl-entry" role="listitem">
Zhang, J., Sun, J., Xue, Y., &amp; Yezheng, L. (2025). A comparative study of fairness in <span>AI</span>-enabled and <span>LLM</span>-based recommendation systems. <em>Journal of Electronic Commerce Research</em>, <em>26</em>, 237–265. <a href="http://www.jecr.org/node/741">http://www.jecr.org/node/741</a>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>